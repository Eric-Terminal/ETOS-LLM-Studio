# watchOS 本地网络权限问题修复指南

## 问题描述

在 watchOS 实体机上，WebSocket 连接到本地服务器时一直卡在"连接中"状态，tcpdump 显示没有任何网络请求发出。虚拟机上工作正常，但实体机完全无法连接。

## 根本原因

**watchOS 在首次使用本地网络前，必须显式请求并获得用户授权**。系统会阻止所有本地网络连接，直到权限被授予。关键问题是：

1. 权限弹窗只在**实际使用**本地网络时才会触发
2. WebSocket 连接在权限授予前就被系统阻塞
3. Bonjour 服务类型配置不当导致权限请求无法正常触发

## 修复内容

### 1. 代码层面修复 (LocalDebugServer.swift)

添加了 `triggerLocalNetworkPermission()` 方法：

- **预检查机制**：在建立 WebSocket 连接前，先尝试创建一个临时 TCP 连接
- **触发权限**：这个临时连接会触发系统的本地网络权限弹窗
- **仅 watchOS**：使用 `#if os(watchOS)` 确保只在 watchOS 上执行
- **超时保护**：5 秒超时机制，避免永久阻塞

工作流程：
```
用户点击连接
    ↓
触发权限检查（临时TCP连接）
    ↓
系统弹出权限请求
    ↓
用户授权
    ↓
建立真正的WebSocket连接
```

### 2. 配置层面修复 (project.pbxproj)

更新 `NSBonjourServices` 声明：

**之前**：
```
INFOPLIST_KEY_NSBonjourServices = _http._tcp;
```

**修复后**：
```
"INFOPLIST_KEY_NSBonjourServices[sdk=*]" = (
    _http._tcp,
    _ws._tcp,
);
```

**同时更新了权限说明文案**：
```
"需要访问本地网络以连接到调试服务器,用于配置管理和文件传输"
```

### 3. 网络参数优化

在 `performConnection()` 中添加了明确的网络接口配置：

```swift
#if os(watchOS)
// 只使用 WiFi，禁用蜂窝和回环
parameters.prohibitedInterfaceTypes = [.cellular, .loopback]
parameters.requiredInterfaceType = .wifi
#endif
```

## 测试步骤

### ⚠️ 重要：完全清理测试

由于之前的测试可能留下了错误的权限状态，**必须**先完全清理：

1. **删除 App**：
   ```
   在 watchOS 上长按应用图标 → 删除应用
   ```

2. **清理构建**：
   ```
   Xcode → Product → Clean Build Folder (⇧⌘K)
   ```

3. **（可选）重置权限**：
   ```
   设置 → 通用 → 重置 → 重置位置与隐私
   ```
   ⚠️ 注意：这会重置所有 App 的隐私设置

### 正确的测试流程

1. **重新构建并安装**：
   ```bash
   # 在 Xcode 中选择 watchOS 设备
   # 点击 Run 或按 ⌘R
   ```

2. **首次启动**：
   - 打开 App
   - 进入远程调试设置
   - 输入服务器地址（例如：192.168.1.100:8765）

3. **点击连接**：
   - 状态会显示："正在请求权限..."
   - **关键时刻**：系统应该弹出权限请求框
   - 弹窗内容：「"ETOS LLM Studio"想要访问本地网络上的设备」

4. **授予权限**：
   - 点击「好」或「允许」
   - 稍等片刻（约 0.5-1 秒）

5. **观察连接**：
   - 状态应该变为："准备中..." → "已连接"
   - 如果成功，你应该能在电脑端看到连接日志

### 预期行为

✅ **成功标志**：
- 首次连接时弹出权限请求
- 授权后立即建立 WebSocket 连接
- tcpdump 能抓到数据包
- 电脑端服务器显示连接成功

❌ **如果仍然失败**：
- 检查电脑端服务器是否正在运行
- 确认 IP 地址正确（手表和电脑在同一 WiFi）
- 检查防火墙设置（Mac 系统偏好设置 → 安全性与隐私 → 防火墙）

## 技术细节

### 为什么虚拟机能工作？

watchOS 模拟器对网络权限的检查比实体机**宽松得多**：
- 模拟器通常共享主机的网络权限
- 不强制要求本地网络权限授权
- 网络沙盒限制较松

### 为什么 API 能触发权限，WebSocket 不能？

- **API 请求**：通常访问公网地址（如 OpenAI API），走的是互联网连接，不受本地网络权限限制
- **WebSocket 到本地 IP**：明确的本地网络访问（192.168.x.x），必须有本地网络权限

### 为什么需要临时连接？

系统的权限触发机制要求：
1. 必须有**真实的网络操作**才会弹出权限请求
2. 但在权限授予前，真正的连接会被阻塞
3. 解决方案：先用一个"牺牲品"连接去触发权限请求

这就像是"敲门"：
- 第一个连接：敲门（触发权限）
- 用户：开门（授权）
- 第二个连接：进门（真正的 WebSocket）

## 常见问题

### Q: 如果已经授予过权限，还会再次请求吗？
A: 不会。系统会记住授权状态，预检查会立即通过。

### Q: 预检查会影响连接速度吗？
A: 首次连接会慢约 0.5-1 秒，后续连接几乎无影响。

### Q: 如果用户拒绝权限会怎样？
A: WebSocket 连接会失败，显示"连接失败"。用户需要去设置中手动授权。

### Q: 手动授权路径？
A: 设置 → 隐私与安全性 → 本地网络 → ETOS LLM Studio

## 验证修复

在实体机上测试时，使用 Console.app（控制台）查看日志：

1. 连接 Apple Watch 到 Mac
2. 打开 Console.app
3. 选择你的 Apple Watch
4. 筛选器：`com.ETOS.LLM.Studio`
5. 查找以下日志：

```
🔐 触发本地网络权限请求...
✅ 本地网络权限检查完成
🔌 开始建立WebSocket连接到 xxx.xxx.xxx.xxx:8765
✅ 已连接到 xxx.xxx.xxx.xxx:8765
```

## 总结

这个修复解决了 watchOS 本地网络权限的"鸡生蛋蛋生鸡"问题：
- 需要连接才能触发权限
- 需要权限才能连接

通过添加一个预检查步骤，我们打破了这个循环，让权限请求能够在正式连接前完成。

祝你测试成功！🎉
